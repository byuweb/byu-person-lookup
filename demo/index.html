<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.byu.edu/byu-theme-components/latest/byu-theme-components.min.css" />
    <script async src="https://cdn.byu.edu/byu-theme-components/latest/byu-theme-components.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta charset="UTF-8">
    <title>Demo: BYU Person Lookup Component</title>
    <style>
        body { min-height: 100vh; display: flex; flex-direction: column; }
        #content { flex: 1; padding: 0.5rem; }
    </style>

    <script type="module" src="https://cdn.byu.edu/byu-person-lookup/latest/byu-person-lookup-bundle.min.js"></script>
    <script type="module" src="https://cdn.byu.edu/byu-person-lookup/latest/byu-personsv2-datasource-bundle.min.js"></script>
    <script type="module" src="https://cdn.byu.edu/byu-person-lookup/latest/byu-personsv3-datasource-bundle.min.js"></script>
    <!--
    <script type="module" src="../dist/byu-person-lookup-bundle.js"></script>
    <script type="module" src="../dist/byu-personsv2-datasource-bundle.js"></script>
    <script type="module" src="../dist/byu-personsv3-datasource-bundle.js"></script>
    -->
</head>
<body>
    <byu-header>
        <h1 slot="site-title">Demo: BYU Person Lookup Component</h1>
    </byu-header>

    <div id="content">

        <h2>PersonsV3 Lookup</h2>
        <byu-person-lookup id="lookup-3" context="directory">
            <byu-personsv3-datasource></byu-personsv3-datasource>
        </byu-person-lookup>

        <h2>PersonsV2 Lookup</h2>
        <byu-person-lookup id="lookup-2" context="directory">
            <byu-personsv2-datasource></byu-personsv2-datasource>
        </byu-person-lookup>

        <p id="selection"></p>
        <div>
            <label for="searchContext">Search Type</label>
            <select id="searchContext">
                <option value="directory">Directory</option>
                <option value="admin">Admin</option>
            </select>
            <br>
            <label for="searchCompact">Compact View</label>
            <input type="checkbox" id="searchCompact">
            <br>
            <label for="searchNoauto">No Autoselect</label>
            <input type="checkbox" id="searchNoauto">
        </div>
        <div>
            <h1>Test Authentication (from WSO2)</h1>
            <p>
            <strong>Instructions</strong>: To test the person lookup components, enter a bearer
            token from WSO2. The token must be generated by an application that is subscribed to the
            Personsv2 API. See
            <a target="_blank" href="https://api.byu.edu/store">https://api.byu.edu/store</a>
            to create an application, subscribe to an API, and generate a token.
            </p>
            <label for="bearer">Bearer Token</label>
            <input id="bearer" type="text" size="40">
        </div>

    </div>

    <byu-footer></byu-footer>

    <script>
        const browserOauthStatus = () => {
            const inputVal = (id, defaultValue) => {
                const elem = document.getElementById(id)
                return elem ? elem.value : defaultValue
            }
            const bearerToken = inputVal('bearer')
            return {
                state: bearerToken ? 'authenticated' : 'unauthenticated',
                user: {
                    personId: inputVal('personId', ''),
                    byuId: inputVal('byuId', ''),
                    netId: inputVal('netId', ''),
                    name: {
                        sortName: inputVal('sortName', 'Student, Joseph Q'),
                        displayName: inputVal('displayName', 'Joe Student'),
                        givenName: inputVal('givenName', 'Joe'),
                        familyName: inputVal('familyName', 'Student'),
                        familyNamePosition: inputVal('familyNamePosition', 'L'),
                    }
                },
                token: {
                    bearer: bearerToken,
                    authorizationHeader: bearerToken ? 'Bearer ' + bearerToken : null,
                    expiresAt: new Date()
                }
            }
        }

        function updateAuthentication () {
            const evt = new CustomEvent('byu-browser-oauth-state-changed', {
                detail: browserOauthStatus(),
                bubbles: true
            })
            document.dispatchEvent(evt)
        }

        document.addEventListener('byu-browser-oauth-current-info-requested', (e) => {
            e.detail.callback(browserOauthStatus())
        })

        document.getElementById('bearer').addEventListener('change', updateAuthentication)

        document.getElementById('lookup-2').addEventListener('byu-lookup-results-select', e => {
            console.log(`Selected byuId: ${e.detail}`)
            const selectionElem = document.getElementById('selection')
            selectionElem.textContent = `Selected person ${JSON.stringify(e.detail, null, 2)}`
        })

        document.getElementById('lookup-3').addEventListener('byu-lookup-results-select', e => {
            console.log(`Selected byuId: ${e.detail}`)
            const selectionElem = document.getElementById('selection')
            selectionElem.textContent = `Selected person ${JSON.stringify(e.detail, null, 2)}`
        })

        document.getElementById('searchContext').addEventListener('change', e => {
            const val = e.target.value
            document.getElementById('lookup-2').setAttribute('context', val)
            document.getElementById('lookup-3').setAttribute('context', val)
        })

        document.getElementById('searchCompact').addEventListener('change', e => {
            const val = e.target.checked
            if (val) {
                document.getElementById('lookup-2').setAttribute('compact', '')
                document.getElementById('lookup-3').setAttribute('compact', '')
            } else {
                document.getElementById('lookup-2').removeAttribute('compact')
                document.getElementById('lookup-3').removeAttribute('compact')
            }
        })

        document.getElementById('searchNoauto').addEventListener('change', e => {
            const val = e.target.checked
            if (val) {
                document.getElementById('lookup-2').setAttribute('no-autoselect', '')
                document.getElementById('lookup-3').setAttribute('no-autoselect', '')
            } else {
                document.getElementById('lookup-2').removeAttribute('no-autoselect')
                document.getElementById('lookup-3').removeAttribute('no-autoselect')
            }
        })
    </script>
</body>
</html>
